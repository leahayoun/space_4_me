<%# app/views/appointments/_simple_calendar.html.erb %>

<% # ‰ªéÂ±ÄÈÉ®ÂèòÈáèÊàñÂÆû‰æãÂèòÈáèËé∑ÂèñÊï∞ÊçÆ %>
<% view_type = local_assigns[:view_type] || @view_type || 'month' %>
<% current_date = local_assigns[:current_date] || @current_date || Date.today %>
<% appointments = local_assigns[:appointments] || @appointments || [] %>

<% if view_type == 'month' %>
  <%# ============ Ëá™ÂÆö‰πâÊúàËßÜÂõæÔºà‰∏ç‰æùËµñgemÔºâ ============ %>
  <% month_start = current_date.beginning_of_month %>
  <% month_end = current_date.end_of_month %>

  <div class="simple-calendar">
    <table>
      <thead>
        <tr>
          <% Date::ABBR_DAYNAMES.each do |day| %>
            <th><%= day %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% (month_start..month_end).each_slice(7) do |week| %>
          <tr>
            <% week.each do |date| %>
              <td class="<%= 'today' if date == Date.today %> <%= 'other-month' if date.month != current_date.month %>">
                <%# Ëé∑ÂèñÂΩìÂ§©ÁöÑÁ∫¶‰ºö %>
                <% day_appointments = appointments.select { |a| a.date == date } %>
                <% daily_feeling = current_user.feelings.where("DATE(created_at) = ?", date).first if current_user.present? %>

                <%= link_to day_details_appointments_path(date: date),
                            class: "calendar-cell-link" do %>
                  <div class="calendar-day
                              <%= 'today' if date == Date.today %>
                              <%= 'other-month' if date.month != current_date.month %>
                              <%= 'has-events' if day_appointments.any? %>
                              <%= 'has-feeling' if daily_feeling.present? %>">

                    <div class="day-number">
                      <%= date.day %>
                    </div>

                    <% if daily_feeling.present? %>
                      <div class="day-mood">
                        <% if daily_feeling.respond_to?(:moods) && daily_feeling.moods.any? %>
                          <% daily_feeling.moods.each do |mood| %>
                            <span class="mood-emoji" title="<%= mood.name %>">
                              <%= mood.icon %>
                            </span>
                          <% end %>
                        <% else %>
                          <span class="mood-emoji" title="Journalis√©">üìù</span>
                        <% end %>
                      </div>
                    <% end %>

                    <% if day_appointments.any? %>
                      <div class="day-events">
                        <% day_appointments.each do |appointment| %>
                          <div class="event-dot"
                               style="background-color: <%= appointment_color(appointment) %>"
                               title="<%= appointment.title %> - <%= appointment.event_type %>">
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>



<% else %>
  <%# ============ Âë®ËßÜÂõæ ============ %>
  <% week_start = current_date.beginning_of_week %>
  <% week_end = current_date.end_of_week %>

  <div class="week-calendar">
    <div class="calendar-inner">




      <div class="week-header">
        <% (week_start..week_end).each do |day| %>
          <div class="weekday-header <%= 'today' if day == Date.today %>">
            <div class="weekday-name"><%= l(day, format: :abbr_day) %></div>
            <div class="weekday-date"><%= day.day %></div>
          </div>
        <% end %>
      </div>

      <div class="week-days">
        <% (week_start..week_end).each do |day| %>
          <% day_feeling = current_user.feelings.where("DATE(created_at) = ?", day).first if current_user.present? %>
          <% day_appointments = appointments.select { |a| a.date == day } %>

          <div class="weekday-wrapper">
            <%= link_to day_details_appointments_path(date: day),
                        class: "weekday-link" do %>
              <div class="weekday <%= 'today' if day == Date.today %>">

                <% if day_feeling.present? %>
                  <div class="weekday-mood">
                    <% if day_feeling.respond_to?(:moods) && day_feeling.moods.any? %>
                      <% day_feeling.moods.each do |mood| %>
                        <span class="mood-emoji" title="<%= mood.name %>">
                          <%= mood.icon %>
                        </span>
                      <% end %>
                    <% else %>
                      <span class="mood-emoji" title="Journalis√©">üìù</span>
                    <% end %>
                  </div>
                <% end %>

                <% if day_appointments.any? %>
                  <% day_appointments.each do |appointment| %>
                    <div class="week-appointment"
                        style="border-left-color: <%= appointment_color(appointment) %>">

                      <div class="appointment-time">
                        <% if appointment.start_time.present? %>
                          <%= appointment.start_time.strftime('%H:%M') %>
                        <% else %>
                          <small class="text-muted">Journ√©e</small>
                        <% end %>
                      </div>

                      <div class="appointment-title"><%= appointment.title %></div>

                      <% if appointment.event_type.present? %>
                        <div class="appointment-type">
                          <small class="text-muted"><%= appointment.event_type %></small>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                <% else %>
                  <div class="empty-day">
                    <% if day_feeling.present? %>
                      <span class="text-muted">‚úîÔ∏è Journalis√©</span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>

          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
