<%# app/views/appointments/_simple_calendar.html.erb %>


<% view_type = local_assigns[:view_type] || @view_type || 'month' %>
<% current_date = local_assigns[:current_date] || @current_date || Date.today %>
<% appointments = local_assigns[:appointments] || @appointments || [] %>
<% if view_type == 'month' %>
  <%# ============ Vue mois personnalis√©e ============ %>
  <% month_start = current_date.beginning_of_month %>
  <% month_end = current_date.end_of_month %>
  <% first_display_date = month_start.beginning_of_week(:monday) %>
  <% last_display_date = month_end.end_of_week(:monday) %>

  <div class="simple-calendar">
    <table>
      <thead>
        <tr>
          <%# Jours de la semaine en fran√ßais %>
          <% %w[Lun Mar Mer Jeu Ven Sam Dim].each do |day| %>
            <th><%= day %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% (first_display_date..last_display_date).each_slice(7) do |week| %>
          <tr>
            <% week.each do |date| %>
              <td class="<%= 'today' if date == Date.today %> <%= 'other-month' if date.month != current_date.month %>">

                <%# ============ ICI : R√âCUP√âRER LES DONN√âES ============ %>
                <%# 1. R√©cup√©rer les rendez-vous du jour %>
                <% day_appointments = appointments.select { |a| a.date == date } %>

                <%# 2. R√âCUP√âRER LE FEELING DU JOUR - C'EST √áA QUI MANQUE ! %>
                <% daily_feeling = current_user.feelings.where("DATE(created_at) = ?", date).first if current_user.present? %>
                <%# ==================================================== %>

                <%= link_to day_details_appointments_path(date: date),
                            class: "calendar-cell-link" do %>
                  <div class="calendar-day
                              <%= 'today' if date == Date.today %>
                              <%= 'other-month' if date.month != current_date.month %>
                              <%= 'has-events' if day_appointments.any? %>
                              <%= 'has-feeling' if daily_feeling.present? %>">

                    <div class="day-number">
                      <%= date.day %>
                    </div>

                    <%# ============ ICI : AFFICHER LES EMOJIS ============ %>
                    <% if daily_feeling.present? %>
                      <div class="day-mood">
                        <% if daily_feeling.respond_to?(:moods) && daily_feeling.moods.any? %>
                          <% daily_feeling.moods.each do |mood| %>
                            <span class="mood-emoji"
                                  title="<%= mood.name %>"
                                  data-bs-toggle="tooltip">
                              <%= mood.icon %>
                            </span>
                          <% end %>
                        <% else %>
                          <%# Si pas de mood sp√©cifique mais feeling existant %>
                          <span class="mood-emoji" title="Journalis√©">üìù</span>
                        <% end %>
                      </div>
                    <% end %>
                    <%# ==================================================== %>

                    <% if day_appointments.any? %>
                      <div class="day-events">
                        <% day_appointments.each do |appointment| %>
                          <div class="event-dot"
                               style="background-color: <%= appointment_color(appointment) %>"
                               title="<%= appointment.title %> - <%= appointment.event_type %>">
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

<% else %>
  <%# ============ Vue semaine (timeline) ============ %>
  <% week_start = current_date.beginning_of_week %>
  <% week_end = current_date.end_of_week %>

  <div class="timeline-week-view">
    <div class="timeline-container">
      <%# Lignes pour chaque jour %>
      <% (week_start..week_end).each do |day| %>
        <% day_feeling = current_user.feelings.where("DATE(created_at) = ?", day).first if current_user.present? %>
        <% day_appointments = appointments.select { |a| a.date == day }.sort_by(&:start_time) %>
        <% display_appointments = day_appointments.first(5) %> <%# Maximum 5 √©v√©nements visibles %>
        <% has_more = day_appointments.size > 5 %>

        <div class="timeline-day-row <%= 'today' if day == Date.today %>">
          <%# Colonne date (fixe) %>
          <div class="day-label">
            <div class="day-name"><%= l(day, format: :abbr_day) %></div>
            <div class="day-date"><%= day.day %></div>

            <% if day_feeling.present? %>
              <div class="day-mood-small">
                <% if day_feeling.respond_to?(:moods) && day_feeling.moods.any? %>
                  <% day_feeling.moods.first(2).each do |mood| %> <%# Maximum 2 √©mojis %>
                    <span class="mood-emoji-small" title="<%= mood.name %>">
                      <%= mood.icon %>
                    </span>
                  <% end %>
                <% else %>
                  <span class="mood-emoji-small" title="Journalis√©">üìù</span>
                <% end %>
              </div>
            <% end %>
          </div>

          <%# Timeline des √©v√©nements (scroll horizontal) %>
          <div class="timeline-events">
            <% if display_appointments.any? %>
              <% display_appointments.each do |appointment| %>
                <%= link_to appointment_path(appointment), class: "timeline-event" do %>
                  <div class="event-block"
                       style="background-color: <%= appointment_color(appointment) %>20;
                              border-left-color: <%= appointment_color(appointment) %>">

                    <div class="event-time">
                      <% if appointment.start_time.present? %>
                        <%= appointment.start_time.strftime('%H:%M') %>
                      <% else %>
                        <small class="text-muted">Journ√©e</small>
                      <% end %>
                    </div>

                    <div class="event-title"><%= appointment.title %></div>

                    <% if appointment.event_type.present? %>
                      <div class="event-type">
                        <small><%= appointment.event_type %></small>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              <% end %>

              <%# Si plus d'√©v√©nements, afficher "Voir plus" %>
              <% if has_more %>
                <%= link_to day_details_appointments_path(date: day), class: "more-events" do %>
                  <div class="more-events-block">
                    +<%= day_appointments.size - 5 %> de plus
                    <small>(Cliquer pour d√©tails)</small>
                  </div>
                <% end %>
              <% end %>
            <% else %>
              <%# Aucun √©v√©nement %>
              <div class="no-events">
                <%= link_to "Ôºã Ajouter", new_appointment_path(date: day), class: "add-event-link" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
